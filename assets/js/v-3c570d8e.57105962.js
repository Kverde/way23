"use strict";(self.webpackChunkway23=self.webpackChunkway23||[]).push([[7330],{92353:(n,s,a)=>{a.r(s),a.d(s,{data:()=>e});const e={key:"v-3c570d8e",path:"/%D0%B0%D1%83%D0%B4%D0%B8%D1%82-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85-%D0%B2-oracle-%D0%BD%D0%B0-%D0%BE%D1%81%D0%BD%D0%BE%D0%B2%D0%B5-%D0%BF%D0%B0%D0%BA%D0%B5%D1%82%D0%BD%D1%8B%D1%85-%D0%BF%D0%B5%D1%80.html",title:"Аудит данных в Oracle на основе пакетных переменных и триггеров",lang:"ru-RU",frontmatter:{title:"Аудит данных в Oracle на основе пакетных переменных и триггеров",date:"2019-07-18",categories:["Базы данных"],tags:["oracle","аудит"]},excerpt:"",headers:[],filePathRelative:"аудит-данных-в-oracle-на-основе-пакетных-пер.md",git:{updatedTime:1692859375e3}}},59749:(n,s,a)=>{a.r(s),a.d(s,{default:()=>c});var e=a(66252),p=a(3577);const t={id:"frontmatter-title",tabindex:"-1"},r=(0,e._)("a",{class:"header-anchor",href:"#frontmatter-title","aria-hidden":"true"},"#",-1),o=(0,e.uE)('<p>В пакеты Oracle можно добавлять переменные. Эти переменные имеют свои значения для каждой сессии. Такое свойство позволяет организовать аудит — лог записей о том кто и когда менял данные в таблицах. Общий алгоритм такой:</p><ul><li>Создаётся пакет с переменными.</li><li>После соединения программа записывает в эти переменные данные о пользователе: идентификатор пользователя, открытый модуль и всё что может понадобится для аудита.</li><li>На таблицы помещаются триггеры которые используют переменные из пакета аудита и записывают информацию о модификации данных в отдельную таблицу.</li></ul><p>Почти все описанные изменения производятся в БД. В клиенте добавляется только код регистрации переменных после коннекта. За счёт этого, такой подход может использоваться даже в наборе старых приложений в которых затруднительно найти и изменить все обращения к таблице в клиентах.</p><p>Пакет может выглядеть примерно так</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> PACKAGE AUD<span class="token punctuation">.</span>MY_AUDIT <span class="token operator">IS</span>\n  curr_user       core<span class="token punctuation">.</span>users<span class="token operator">%</span>rowtype<span class="token punctuation">;</span>\n  curr_module     core<span class="token punctuation">.</span>modules<span class="token operator">%</span>rowtype<span class="token punctuation">;</span>\n\n  <span class="token comment">-- Установка текущего пользователя</span>\n  <span class="token keyword">procedure</span> SetCurrentUser\n    <span class="token punctuation">(</span>currentUserID <span class="token operator">in</span> core<span class="token punctuation">.</span>users<span class="token punctuation">.</span>rid<span class="token operator">%</span><span class="token keyword">type</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">-- Установка текущего модуля</span>\n  <span class="token keyword">procedure</span> SetCurrentModule\n    <span class="token punctuation">(</span>currentModuleID <span class="token operator">in</span> core<span class="token punctuation">.</span>modules<span class="token punctuation">.</span>rid<span class="token operator">%</span><span class="token keyword">type</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">-- Одна процедура для установки пользователя и модуля</span>\n  <span class="token keyword">procedure</span> SetCurrentAuditParams\n    <span class="token punctuation">(</span>currentUserID <span class="token operator">in</span> core<span class="token punctuation">.</span>users<span class="token punctuation">.</span>rid<span class="token operator">%</span><span class="token keyword">type</span><span class="token punctuation">,</span>\n     currentModuleID <span class="token operator">in</span> core<span class="token punctuation">.</span>modules<span class="token punctuation">.</span>rid<span class="token operator">%</span><span class="token keyword">type</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">-- Получение информации о текущем пользователе</span>\n  <span class="token keyword">function</span> GetCurrentUser\n    <span class="token keyword">return</span> core<span class="token punctuation">.</span>users<span class="token operator">%</span>rowtype<span class="token punctuation">;</span>\n\n  <span class="token comment">-- Получение информации о текущем модуле</span>\n  <span class="token keyword">function</span> GetCurrentModule\n    <span class="token keyword">return</span> core<span class="token punctuation">.</span>modules<span class="token operator">%</span>rowtype<span class="token punctuation">;</span>\n\n  <span class="token comment">-- Функции для отдельных полей могут использоваться в запросах или представлениях</span>\n  <span class="token keyword">function</span> current_user_name <span class="token keyword">return</span> core<span class="token punctuation">.</span>users<span class="token punctuation">.</span>name<span class="token operator">%</span><span class="token keyword">type</span><span class="token punctuation">;</span>\n\n<span class="token keyword">end</span> MY_AUDIT<span class="token punctuation">;</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>Недостаток такого подхода — исключение <code>ORA-04068: существующее состояние пакетов было сброшено</code>. Оно происходит если в сессии используется какой-либо пакет и во время работы сессии этот пакет перекомпилируется. Такая ситуация возникакет, например, при обновлении БД, без отключения клиентов. После исключения все переменные всех пакетов, в том числе в пакете аудита, сбрасываются и регистрацию сессии нужно производить заново.</p>',6),c={render:function(n,s){return(0,e.wg)(),(0,e.iD)(e.HY,null,[(0,e._)("h1",t,[r,(0,e.Uk)(" "+(0,p.zw)(n.$frontmatter.title),1)]),o],64)}}}}]);