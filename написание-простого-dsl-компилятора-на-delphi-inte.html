<!DOCTYPE html>
<html lang="ru-RU">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.24">
    <meta name="theme-color" content="#ffffff"><meta name="yandex-verification" content="bbf10c47bf8b55fb"><link rel="icon" href="/assets/favicons/favicon.svg"><link rel="mask-icon" href="/assets/favicons/mask-icon.svg" color="red"><link rel="apple-touch-icon" href="/assets/favicons/apple-touch-icon.png"><link rel="manifest" href="manifest.json"><script>
	    var __rm__config = {
        projectId: '-Mibn7-xoaevC6Q4qq9f',
        locale: 'ru',
        contextWidget: 0,
        embedBtn: 0,
        floatingBtn: 1,
        floatingBtnPosition: 'left',
        floatingBtnStyle: 'light',
			};
    </script><script src="https://widget.revisionme.com/app.js" defer="defer" id="rm_app_script"></script><title>–ù–∞–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–≥–æ DSL –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞ –Ω–∞ Delphi (Intermezzo) | Way23</title><meta name="description" content="–ë–ª–æ–≥ –æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–∏">
    <link rel="preload" href="/assets/js/runtime~app.25176522.js" as="script"><link rel="preload" href="/assets/css/styles.1005c642.css" as="style"><link rel="preload" href="/assets/js/1812.ebb0a1a7.js" as="script"><link rel="preload" href="/assets/js/app.b6198e79.js" as="script">
    <link rel="stylesheet" href="/assets/css/styles.1005c642.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container no-sidebar"><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><span class="site-name">Way23</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/" class="nav-link" aria-label="–ì–ª–∞–≤–Ω–∞—è"><!--[--><!--]--> –ì–ª–∞–≤–Ω–∞—è <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/categories.md" class="nav-link" aria-label="–ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º"><!--[--><!--]--> –ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/contacts.md" class="nav-link" aria-label="–ö–æ–Ω—Ç–∞–∫—Ç—ã"><!--[--><!--]--> –ö–æ–Ω—Ç–∞–∫—Ç—ã <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><div class="sidebar-mask"></div><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/" class="nav-link" aria-label="–ì–ª–∞–≤–Ω–∞—è"><!--[--><!--]--> –ì–ª–∞–≤–Ω–∞—è <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/categories.md" class="nav-link" aria-label="–ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º"><!--[--><!--]--> –ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/contacts.md" class="nav-link" aria-label="–ö–æ–Ω—Ç–∞–∫—Ç—ã"><!--[--><!--]--> –ö–æ–Ω—Ç–∞–∫—Ç—ã <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--]--></ul><!--[--><!--]--></aside><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="frontmatter-title" tabindex="-1"><a class="header-anchor" href="#frontmatter-title" aria-hidden="true">#</a> –ù–∞–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–≥–æ DSL –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞ –Ω–∞ Delphi (Intermezzo)</h1><p>–ü–µ—Ä–µ–≤–æ–¥ –ø–æ—Å—Ç–∞ <a href="https://www.thedelphigeek.com/2017/10/writing-simple-dsl-compiler-with-delphi_17.html" target="_blank" rel="noopener noreferrer">Writing a Simple DSL Compiler with Delphi (Intermezzo)<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>.</p><p>–ö–æ–≥–¥–∞ —è –ø–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–ª —Å—Ç–∞—Ç—å—é –ø—Ä–æ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä –¥–ª—è –º–æ–µ–≥–æ <a href="http://way23.ru/%D0%BD%D0%B0%D0%BF%D0%B8%D1%81%D0%B0%D0%BD%D0%B8%D0%B5-%D0%BF%D1%80%D0%BE%D1%81%D1%82%D0%BE%D0%B3%D0%BE-dsl-%D0%BA%D0%BE%D0%BC%D0%BF%D0%B8%D0%BB%D1%8F%D1%82%D0%BE%D1%80%D0%B0-%D0%BD%D0%B0-delphi-0/" target="_blank" rel="noopener noreferrer">–∏–≥—Ä—É—à–µ—á–Ω–æ–≥–æ —è–∑—ã–∫–æ–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>, —è –æ–±–Ω–∞—Ä—É–∂–∏–ª —á—Ç–æ –∫–æ–Ω—Ü–µ–ø—Ü–∏—é –æ–±—ë—Ä—Ç–∫–∏ —Ü–µ–ª–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã –≤ —Å–≤—è–∑–∫—É –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π (—á—Ç–æ –¥–µ–ª–∞–µ—Ç –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä) —á—Ä–µ–∑–≤—ã—á–∞–π–Ω–æ —Å–ª–æ–∂–Ω–∞ –¥–ª—è –æ–±—ä—è—Å–Ω–µ–Ω–∏—è. –ü–æ—ç—Ç–æ–º—É —è –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª —É–ø—Ä–æ—à–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞, –Ω–∞–ø–∏—Å–∞–Ω–Ω—É—é –¥–ª—è –æ—á–µ–Ω—å —É–ø—Ä–æ—à–µ–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞... –∞ –∑–∞—Ç–µ–º —è —Ç–∞–∫ –∏ –Ω–µ —Å–º–æ–≥ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∏ –¥–æ–±–∞–≤–∏–ª AST, –ø–∞–∫—Ä—Å–µ—Ä –∏ —Ç–æ–∫–∏–Ω–µ–∑–∞—Ç–æ—Ä.</p><p>–†–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –≤—Å–µ–≥–æ —ç—Ç–æ–≥–æ —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ <a href="https://github.com/gabr42/SimpleDSLCompiler/blob/master/introduction.dpr" target="_blank" rel="noopener noreferrer">introduction.dpr<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>, –∞–≤—Ç–æ–Ω–æ–º–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ –∫–æ—Ç–æ—Ä–∞—è —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —è–∑—ã–∫ (–æ—á–µ–Ω—å —Ç—Ä–∏–≤–∏–∞–ª—å–Ω—ã–π) –≤–º–µ—Å—Ç–µ —Å –ø–æ–ª–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π, –Ω–∞–ø–∏—Å–∞–Ω–Ω–∞—è –≤ —Å—Ç–∏–ª–µ <a href="https://ru.wikipedia.org/wiki/%D0%93%D1%80%D0%B0%D0%BC%D0%BE%D1%82%D0%BD%D0%BE%D0%B5_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5" target="_blank" rel="noopener noreferrer">–ì—Ä–∞–º–æ—Ç–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>. –£–ø—Ä–æ—â–µ–Ω–æ ‚Äî –≤—ã –º–æ–∂–µ—Ç–µ —á–∏—Ç–∞—Ç—å –µ—ë —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑ –∫–∞–∫ –∏—Å—Ç–æ—Ä–∏—é.</p><p>–í –∫–∞—á–µ—Å—Ç–≤–µ intermezzo –∏ –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –º–æ–µ–≥–æ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞, —è –æ–ø–∏—à—É —ç—Ç—É –ø—Ä–æ–≥—Ä–∞–º–º—É –∑–¥–µ—Å—å –ø–æ–ª–Ω–æ—Å—Ç—å—é, –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–≤ –µ—ë –∫–∞–∫ –ø–æ—Å—Ç –≤ –±–ª–æ–≥.</p><h2 id="introduction-dpr" tabindex="-1"><a class="header-anchor" href="#introduction-dpr" aria-hidden="true">#</a> introduction.dpr</h2><p>–≠—Ç–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ —è–≤–ª—è–µ—Ç—Å—è –º—è–≥–∫–∏–º –≤–≤–µ–¥–µ–Ω–∏–µ–º –≤ —Ç–µ–º—É &quot;compiler-compiler&quot; (–ø—Ä–æ–≥—Ä–∞–º–º –∫–æ—Ç–æ—Ä—ã–µ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä—ã –∏–ª–∏ –∏—Ö —á–∞—Å—Ç–∏). –û–Ω–∞ –Ω–∞–ø–∏—Å–∞–Ω–∞ –≤ —Å—Ç–∏–ª–µ –ì—Ä–∞–º–æ—Ç–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è —á—Ç–µ–Ω–∏—è –æ—Ç –Ω–∞—á–∞–ª–∞ –¥–æ –∫–æ–Ω—Ü–∞.</p><div class="language-delphi ext-delphi line-numbers-mode"><pre class="language-delphi"><code>program introduction;
{$APPTYPE CONSOLE}
{$R *.res}
uses
  System.SysUtils,
  System.Classes,
  System.Character,

  System.Generics.Collections;
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>–ù–∞—à–∞ –∑–∞–¥–∞—á–∞: –º—ã —Ö–æ—Ç–∏–º –≤—ã—á–∏—Å–ª—è—Ç—å –≤—ã—Ä–∞–∂–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–µ</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>   number1 + number2 + ... + numberN
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>–í—Å–µ —á–∏—Å–ª–∞ —Ü–µ–ª—ã–µ –∏ –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–µ, —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –æ–ø–µ—Ä–∞—Ç–æ—Ä ‚Äî —Å–ª–æ–∂–µ–Ω–∏–µ, –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è.</p><p>–§–æ—Ä–º–∞–ª—å–Ω–æ, –º—ã –º–æ–∂–µ–º –æ–ø–∏—Å–∞—Ç—å –Ω–∞—à—É –ø—Ä–æ–≥—Ä–∞–º–º—É —Å–ª–µ–¥—É—é—â–µ–π –≥—Ä–∞–º–º–∞—Ç–∏–∫–æ–π</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>S ‚Üí Term
Term ‚Üí number
Term ‚Üí Term &#39;+&#39; Term
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>–ü—Ä–æ–±–µ–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è –ø–∞—Ä—Å–µ—Ä–æ–º –∏ —Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –Ω–µ —è–≤–ª—è—é—Ç—Å—è —á–∞—Å—Ç—å—é –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏.</p><p>–ú—ã –Ω–∞—á–Ω—ë–º —Å –æ—á–µ–Ω—å –ø—Ä–æ—Å—Ç–æ–≥–æ AST –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞–∑–æ–±—Ä–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –ø—Ä–æ–≥—Ä–∞–º–º—ã</p><div class="language-delphi ext-delphi line-numbers-mode"><pre class="language-delphi"><code>type
  TTerm = class abstract
  end; 

  TAST = TTerm;
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>–ù–∞ –≤–µ—Ä—Ö—É –Ω–∞—à–µ–≥–æ –¥–µ—Ä–µ–≤–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è &#39;term&#39; (—Å–ª–∞–≥–∞–µ–º–æ–µ). <em>–°–ª–∞–≥–∞–µ–º–æ–µ</em> –º–æ–∂–µ—Ç –±—ã—Ç—å –ª–∏–±–æ <em>–∫–æ–Ω—Å—Ç–∞–Ω—Ç–æ–π</em> –ª–∏–±–æ <em>—Å–ª–æ–∂–µ–Ω–∏–µ–º</em>.</p><p><em>–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞</em>, –∫–∞–∫ –∏ –º–æ–∂–Ω–æ –æ–∂–∏–¥–∞—Ç—å, —Å–æ–¥–µ—Ä–∂–∏—Ç —Ü–µ–ª–æ—á–∏—Å–ª–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.</p><p>–ó–¥–µ—Å—å –º—ã –Ω–µ–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã ‚Äî —è–∑—ã–∫ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–µ —á–∏—Å–ª–∞, –Ω–æ AST –±–æ–ª–µ–µ –æ–±—â–µ–µ –∏ –¥–æ–ø—É—Å–∫–∞–µ—Ç –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ —á–∏—Å–ª–∞. –ú—ã –±—É–¥–µ–º –ø—Ä–æ—Å—Ç–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ.</p><div class="language-delphi ext-delphi line-numbers-mode"><pre class="language-delphi"><code>  TConstant = class(TTerm)
  strict private
    FValue: integer;
  public
    constructor Create(AValue: integer);
    property Value: integer read FValue write FValue;
  end;
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><em>–°–ª–æ–∂–µ–Ω–∏–µ</em> ‚Äî –±–∏–Ω–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –Ω–∞–¥ –¥–≤—É–º—è <em>—Å–ª–∞–≥–∞–µ–º—ã–º–∏</em> (–ª–µ–≤—ã–º –∏ –ø—Ä–∞–≤—ã–º).</p><div class="language-delphi ext-delphi line-numbers-mode"><pre class="language-delphi"><code>  TAddition = class(TTerm)
  strict private
    FTerm1: TTerm;
    FTerm2: TTerm;
  public
    constructor Create(ATerm1, ATerm2: TTerm);
    destructor  Destroy; override;
    property Term1: TTerm read FTerm1 write FTerm1;
    property Term2: TTerm read FTerm2 write FTerm2;
  end;

constructor TConstant.Create(AValue: integer);
begin
  inherited Create;
  FValue := AValue;
end;

constructor TAddition.Create(ATerm1, ATerm2: TTerm);
begin
  inherited Create;
  FTerm1 := ATerm1;
  FTerm2 := ATerm2;
end;
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>–û–±—ä–µ–∫—Ç <code>TAddition</code> —è–≤–ª—è–µ—Ç—Å—è –≤–ª–∞–¥–µ–ª—å—Ü–µ–º —Å–≤–æ–∏—Ö –¥–æ—á–µ—Ä–Ω–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤.</p><div class="language-delphi ext-delphi line-numbers-mode"><pre class="language-delphi"><code>destructor TAddition.Destroy;
begin
  FreeAndNil(FTerm1);
  FreeAndNil(FTerm2);
  inherited;

end;
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>–°–ª–µ–¥—É—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å—Ç—Ä–æ–∏—Ç AST –∏–∑ –º–∞—Å—Å–∏–≤–∞ —á–∏—Å–µ–ª. –í–ª–∞–¥–µ–ª–µ—Ü –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ AST.</p><div class="language-delphi ext-delphi line-numbers-mode"><pre class="language-delphi"><code>function CreateAST(const values: TArray): TAST;
var
  iValue: integer;
begin
  if Length(values) = 0 then

    Exit(nil);
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>–ú—ã –±—É–¥–µ–º —Å–æ–∑–¥–∞–≤–∞—Ç—å <em>—Å–ª–∞–≥–∞–µ–º—ã–µ</em> –∏–∑ –º–∞—Å—Å–∏–≤ –≤ –Ω–∞—á–∏–Ω–∞—è —Å –∫–æ–Ω—Ü–∞ –∫ –Ω–∞—á–∞–ª—É –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–∞–∫ —Å–ª–∞–≥–∞–µ–º—ã–µ –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —Å–ª–∞–≥–∞–µ–º—ã—Ö.</p><div class="language-delphi ext-delphi line-numbers-mode"><pre class="language-delphi"><code>  Result := TConstant.Create(values[High(values)]);

  for iValue := High(values) - 1 downto Low(values) do
    Result := TAddition.Create(TConstant.Create(values[iValue]), Result);

end;
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>–í—ã–∑–æ–≤ <code>CreateAST([1, 2, 3])</code> —Å–æ–∑–¥–∞—Å—Ç —Å–ª–µ–¥—É—é—â–µ–µ AST —Å —Ç—Ä–µ–º—è —É–∑–ª–∞–º–∏:</p><div class="language-delphi ext-delphi line-numbers-mode"><pre class="language-delphi"><code>TAddition
   Term1 = TConstant
           Value = 1
   Term2 = TAddition
           Term1 = TConstant
                   Value = 2
           Term2 = TConstant
                   Value = 3
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>–î–∞–≤–∞–π—Ç–µ —Å–¥–µ–ª–∞–µ–º –∏–∑ —ç—Ç–æ–≥–æ —Ç–µ—Å—Ç.</p><p>–°–Ω–∞—á–∞–ª–∞, –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—é—Ç –∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤—ã–≤–∞—é—Ç —Ç–∏–ø.</p><div class="language-delphi ext-delphi line-numbers-mode"><pre class="language-delphi"><code>function IsConstant(term: TTerm; out add: TConstant): boolean;
begin
  Result := term is TConstant;
  if Result then
    add := TConstant(term);
end;

function IsAddition(term: TTerm; out add: TAddition): boolean;
begin
  Result := term is TAddition;
  if Result then
    add := TAddition(term);

end;
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>–ò —Ç–µ–ø–µ—Ä—å —Ä–µ–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç.</p><div class="language-delphi ext-delphi line-numbers-mode"><pre class="language-delphi"><code>procedure TestCreateAST;
var
  add1  : TAddition;
  add2  : TAddition;
  ast   : TAST;
  const1: TConstant;
  const2: TConstant;
  const3: TConstant;
begin
  ast := CreateAST([1, 2, 3]);
  try
    if assigned(ast)
       and IsAddition(ast, add1)
       and IsConstant(add1.Term1, const1) and (const1.Value = 1)
       and IsAddition(add1.Term2, add2)
       and IsConstant(add2.Term1, const2) and (const2.Value = 2)
       and IsConstant(add2.Term2, const3) and (const3.Value = 3)
    then
      // everything is fine
    else
      raise Exception.Create(&#39;CreateAST is not working correctly!&#39;);
  finally FreeAndNil(ast); end;

end;
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>–ú—ã –Ω–∞–ø–∏—à–µ–º –ø—Ä–æ—Å—Ç–æ –ø–∞—Ä—Å–µ—Ä –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞—Å—Ç AST –∏–∑ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–µ <code>number1 + number2 + ... numberN</code>.</p><p>–ù–∞—à &quot;—è–∑—ã–∫&quot; –∏–º–µ–µ—Ç —Ç–æ–ª—å–∫–æ –¥–≤–∞ —Ç–æ–∫–µ–Ω–∞: &#39;number&#39; (—á–∏—Å–ª–æ) –∏ &#39;addition&#39; (—Å–ª–æ–∂–µ–Ω–∏–µ). –ü—Ä–æ–±–µ–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –Ω–µ –≤–∞–∂–Ω—ã –±—É–¥—É—Ç –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —Ç–æ–∫–∏–Ω–µ–∑–∞—Ç–æ—Ä–æ–º (–ª–µ–∫—Å–∏—á–µ—Å–∫–∏–º –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–æ–º). –í—Å–µ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –±—É–¥—É—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Ç–æ–∫–µ–Ω &#39;unknown&#39;.</p><div class="language-delphi ext-delphi line-numbers-mode"><pre class="language-delphi"><code>type
  TTokenKind = (tkNumber, tkAddition, tkUnknown);
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>–ë–æ–ª—å—à–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø—Ä–æ —Ç–æ–∫–µ–Ω—ã:</p><ul><li>tkNumber ‚Äî &quot;\d+&quot;</li><li>tkAddition ‚Äî &quot;+&quot;</li><li>&quot;\s+&quot; ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è</li><li>tkUnknown ‚Äî –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ: &quot;[^\d+\s]&quot;</li></ul><p>–¢–æ–∫–∏–Ω–µ–∑–∞—Ç–æ—Ä –∏ –ø–∞—Ä—Å–µ—Ä –Ω—É–∂–¥–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Å–ª–µ–¥—É—é—â–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:</p><ul><li>–í—Ö–æ–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞.</li><li>–¢–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è.</li></ul><p>–ö–ª–∞—Å—Å <code>TStringStream</code> –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –æ–±–∞ —ç—Ç–∏ –ø—É–Ω–∫—Ç–∞ —Ç–∞–∫ —á—Ç–æ –º—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ.</p><div class="language-delphi ext-delphi line-numbers-mode"><pre class="language-delphi"><code>  TParserState = TStringStream;
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ç–æ–∫–∏–Ω–µ–∑–∞—Ç–æ—Ä–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π —Ç–æ–∫–µ–Ω –∏ –µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏–µ –∫–∞–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º <code>var</code> –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç <code>True</code> –µ—Å–ª–∏ –ø–∞—Ä–∞ —Ç–æ–∫–µ–Ω\–∑–Ω–∞—á–µ–Ω–∏–µ –±—ã–ª–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∞ –∏ <code>False</code> –µ—Å–ª–∏ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç –∫–æ–Ω–µ—Ü –ø–æ—Ç–æ–∫–∞.</p><p>–≠—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ—á–µ–Ω—å –ø—Ä–æ—Å—Ç–∞, –Ω–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∫—Ä–∞–π–Ω–µ –Ω–µ–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞.</p><div class="language-delphi ext-delphi line-numbers-mode"><pre class="language-delphi"><code>function GetToken(state: TParserState; var token: TTokenKind; var value: string): boolean;
var
  nextChar: string;
  position: int64;
begin
  repeat
    nextChar := state.ReadString(1);
    Result := (nextChar &lt;&gt; &#39;&#39;);
    // Ignore whitespace
  until (not Result) or (not nextChar[1].IsWhiteSpace);

  if Result then begin
    value := nextChar[1];

    // Addition
    if value = &#39;+&#39; then
      token := tkAddition

    // Number
    else if value[1].IsNumber then begin
      token := tkNumber;
      repeat
        position := state.Position;
        nextChar := state.ReadString(1);

        // End of stream, stop
        if nextChar = &#39;&#39; then
          break //repeat

        // Another number, append
        else if nextChar[1].IsNumber then
          value := value + nextChar[1]

        // Read too far, retract
        else begin
          state.Position := position;
          break; //repeat
        end;
      until false;
    end

    // Unexpected input
    else
      token := tkUnknown;
  end;

end;
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p>–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–µ—Å—Ç–æ–≤ –¥–ª—è —Ç–æ–∫–∏–Ω–µ–∑–∞—Ç–æ—Ä–∞..</p><p><code>ExpectFail(state)</code> –≤—ã–∑—ã–≤–∞–µ—Ç <code>GetToken</code> –∏ –æ–∂–∏–¥–∞–µ—Ç —á—Ç–æ –æ–Ω –≤–µ—Ä–Ω—ë—Ç <code>False</code>.</p><div class="language-delphi ext-delphi line-numbers-mode"><pre class="language-delphi"><code>procedure ExpectFail(state: TParserState);
var
  token: TTokenKind;
  value: string;
begin
  if GetToken(state, token, value) then
    raise Exception.Create(&#39;ExpectFail failed&#39;);

end;
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><code>Expect(State, token, value)</code> –≤—ã–∑—ã–≤–∞–µ—Ç <code>GetNextToken</code> –∏ –æ–∂–∏–¥–∞–µ—Ç —á—Ç–æ –æ–Ω –≤–µ—Ä–Ω—ë—Ç <code>True</code> –∏ —Ç–µ –∂–µ —Ç–æ–∫–µ–Ω/–∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ—Ç–æ—Ä—ã–µ –ø–µ—Ä–µ–¥–∞–Ω—ã –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö.</p><div class="language-delphi ext-delphi line-numbers-mode"><pre class="language-delphi"><code>procedure Expect(state: TParserState; expectedToken: TTokenKind;   expectedValue: string);
var
  token: TTokenKind;
  value: string;
begin
  if not GetToken(state, token, value) then
    raise Exception.Create(&#39;Expect failed&#39;)

  else if token &lt;&gt; expectedToken then
    raise Exception.CreateFmt(            &#39;Expect encountered invalid token kind (%d, expected %d)&#39;,
            [Ord(token), Ord(expectedToken)])

  else if value &lt;&gt; expectedValue then
    raise Exception.CreateFmt(            &#39;Expect encountered invalid value (%s, expected %s)&#39;,
            [value, expectedValue])
end;

procedure TestGetToken;
var
  state: TParserState;
begin
  state := TParserState.Create(&#39;&#39;);
  ExpectFail(state);
  FreeAndNil(state);

  state := TParserState.Create(&#39;1&#39;);
  Expect(state, tkNumber, &#39;1&#39;);
  ExpectFail(state);
  FreeAndNil(state);

  state := TParserState.Create(&#39;1+22 333 Ab&#39;);
  Expect(state, tkNumber, &#39;1&#39;);
  Expect(state, tkAddition, &#39;+&#39;);
  Expect(state, tkNumber, &#39;22&#39;);
  Expect(state, tkNumber, &#39;333&#39;);
  Expect(state, tkUnknown, &#39;A&#39;);
  Expect(state, tkUnknown, &#39;b&#39;);
  ExpectFail(state);
  FreeAndNil(state);

end;
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>–ü–∞—Ä—Å–µ—Ä –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ª—é–±—É—é –¥–æ–ø—É—Å—Ç–∏–º—É—é —Å—Ç—Ä–æ–∫—É –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –µ—ë –≤ AST.</p><p>–ï—Å–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞, –æ–Ω —Å–æ–∑–¥–∞—Å—Ç AST –¥–ª—è —ç—Ç–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã, –≤–µ—Ä–Ω—ë—Ç –µ–≥–æ –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–µ <code>ast</code> –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –±—É–¥–µ—Ç <code>True</code>.</p><p>–ï—Å–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –Ω–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞, –ø–∞—Ä–∞–º–µ—Ç—Ä <code>ast</code> –±—É–¥–µ—Ç <code>nil</code> –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ñ—É–Ω–∫—Ü–∏–∏ <code>False</code>.</p><p>–ü—É—Å—Ç–æ–π –≤–≤–æ–¥ –Ω–µ –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è.</p><div class="language-delphi ext-delphi line-numbers-mode"><pre class="language-delphi"><code>function Parse(const prog: string; var ast: TAST): boolean;
var
  accept : TTokenKind;
  numbers: TList;
  state  : TParserState;
  token  : TTokenKind;
  value  : string;
begin
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>–ú—ã –º–æ–∂–µ–º –ª–µ–≥–∫–æ —É–≤–∏–¥–µ—Ç—å –∫–∞–∫ –ø–æ–∫–∞–∑–∞–Ω–Ω–∞—è –≥—Ä–∞–º–º–∞—Ç–∏–∫–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ª–µ–¥—É—é—â—É—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–æ–≤:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>   tkNumber (tkAddition tkNumber)*
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>(–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ –æ–ø—É—â–µ–Ω–æ –≤ –∫–∞—á–µ—Å—Ç–≤–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–ª—è —á–∏—Ç–∞—Ç–µ–ª—è)</p><p>–ö–æ–¥ –ø—Ä–æ–≤–µ—Ä–∏—Ç —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∏ –∏–∑–≤–ª–µ—á—ë—Ç –∏–∑ —Å—Ç—Ä–æ–∫–∏ –≤—Å–µ —á–∏—Å–ª–∞ –≤ <code>TArray</code>.</p><p>–í –∫–æ–Ω—Ü–µ –æ–Ω –ø–µ—Ä–µ–¥–∞—Å—Ç —ç—Ç–æ—Ç –º–∞—Å—Å–∏–≤ –≤ —Ñ—É–Ω–∫—Ü–∏—é <code>CreateAST</code> –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è AST.</p><div class="language-delphi ext-delphi line-numbers-mode"><pre class="language-delphi"><code>   ast := nil;
  Result := false;

  state := TParserState.Create(prog);
  try
    numbers := TList.Create;
    try
      accept := tkNumber;
      while GetToken(state, token, value) do begin
        if token &lt;&gt; accept then
          Exit;
        if accept = tkNumber then begin
          numbers.Add(StrToInt(value));
          accept := tkAddition;
        end
        else
          accept := tkNumber;
      end;

      if accept = tkNumber then
        // Last token in the program was tkAddition, which is not allowed.
        Exit;

      if numbers.Count &gt; 0 then begin
        ast := CreateAST(numbers.ToArray);
        Result := true;
      end;
    finally FreeAndNil(numbers); end;
  finally FreeAndNil(state); end;

end;
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>–ù–∞–º –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ —Ç–µ—Å—Ç–æ–≤...</p><div class="language-delphi ext-delphi line-numbers-mode"><pre class="language-delphi"><code>procedure TestParse;
var
  add1  : TAddition;
  add2  : TAddition;
  ast   : TAST;
  const1: TConstant;
  const2: TConstant;
  const3: TConstant;
begin
  if not Parse(&#39;1+2 + 3&#39;, ast) then
    raise Exception.Create(&#39;Parser failed&#39;);
  try
    if assigned(ast)
       and IsAddition(ast, add1)
       and IsConstant(add1.Term1, const1) and (const1.Value = 1)
       and IsAddition(add1.Term2, add2)
       and IsConstant(add2.Term1, const2) and (const2.Value = 2)
       and IsConstant(add2.Term2, const3) and (const3.Value = 3)
    then
      // everything is fine
    else
      raise Exception.Create(&#39;CreateAST is not working correctly!&#39;);
  finally FreeAndNil(ast); end;

  if Parse(&#39;1+2 +&#39;, ast) then begin
    if assigned(ast) then
      raise Exception.Create(&#39;Invalid program resulted in an AST!)&#39;)
    else
      raise Exception.Create(&#39;Invalid program compiled into an empty AST!&#39;);
  end;

end;
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>–î–ª—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ —ç—Ç–æ–≥–æ AST –º—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç—É—é —Ä–µ–∫—É—Ä—Å–∏—é.</p><div class="language-delphi ext-delphi line-numbers-mode"><pre class="language-delphi"><code>function InterpretAST(ast: TAST): integer;
var
  add1  : TAddition;
  const1: TConstant;
begin
  if not assigned(ast) then
    raise Exception.Create(&#39;Result is undefined!&#39;);
  // Alternatively, we could use Nullable as result, 
  // with Nullable.Null as a default value.

  if IsConstant(ast, const1) then
    Result := const1.Value
  else if IsAddition(ast, add1) then
    Result := InterpretAST(add1.Term1) + InterpretAST(add1.Term2)
  else
    raise Exception.Create(&#39;Internal error. Unknown AST element: &#39; +      ast.ClassName);

end;
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>–ù–µ—Å–∫–æ–ª—å–∫–æ sanity tests –≤—Å–µ–≥–¥–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é—Ç—Å—è...</p><div class="language-delphi ext-delphi line-numbers-mode"><pre class="language-delphi"><code>procedure TestInterpretAST;

  procedure Test(const testName: string; const values: TArray;    expectedResult: integer);
  var
    ast       : TAST;
    calcResult: integer;
  begin
    ast := CreateAST(values);
    if not assigned(ast) then
      raise Exception.CreateFmt(&#39;Compilation failed in test %s&#39;, [testName]);

    try
      calcResult := InterpretAST(ast);
      if calcResult &lt;&gt; expectedResult then
        raise Exception.CreateFmt(
                &#39;Evaluation failed in test %s. &#39; +
                &#39;Calculated result %d &lt;&gt; expected result %d&#39;,
                [testName, calcResult, expectedResult]);
    finally
      FreeAndNil(ast);
    end;
  end;

begin
  Test(&#39;1&#39;, [42], 42);
  Test(&#39;2&#39;, [1, 2, 3], 6);
  Test(&#39;3&#39;, [2, -2, 3, -3], 0);

end;
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>–î–ª—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ —ç—Ç–æ–≥–æ AST, –º—ã –¥–æ–ª–∂–Ω—ã:</p><ul><li>–ò–∑–º–µ–Ω–∏—Ç—å –∫–∞–∂–¥—ã–π —É–∑–µ–ª —Å —Ç–∏–ø–æ–º &#39;constant&#39; –≤ –∞–Ω–æ–Ω–∏–º–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –∫–æ—Ç–æ—Ä–∞—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ —ç—Ç–æ–≥–æ —É–∑–ª–∞.</li><li>–ò–∑–º–µ–Ω–∏—Ç—å –∫–∞–∂–¥—ã–π —É–∑–µ–ª —Å —Ç–∏–ø–æ–º &#39;summation&#39; –≤ –∞–Ω–æ–Ω–∏–º–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –∫–æ—Ç–æ—Ä–∞—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –¥–≤—É—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤. <ul><li>–ü–µ—Ä–≤—ã–π - –∞–Ω–æ–Ω–∏–º–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∫–æ—Ç–æ—Ä–∞—è –≤—ã—á–∏—Å–ª—è–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –ª–µ–≤–æ–≥–æ —Å–ª–∞–≥–∞–µ–º–æ–≥–æ –∏</li><li>–≤—Ç–æ—Ä–æ–π - –∞–Ω–æ–Ω–∏–º–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∫–æ—Ç–æ—Ä–∞—è –≤—ã—á–∏—Å–ª—è–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∞–≤–æ–≥–æ —Å–ª–∞–≥–∞–µ–º–æ–≥–æ</li></ul></li><li><a href="http://docwiki.embarcadero.com/RADStudio/Tokyo/en/Anonymous_Methods_in_Delphi#Variable_Binding_Mechanism" target="_blank" rel="noopener noreferrer">–ú–µ—Ö–∞–Ω–∏–∑–º —Å–≤—è–∑—ã–≤–∞–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> –∑–∞–±–æ—Ç–∏—Ç—Å—è –æ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</li></ul><div class="language-delphi ext-delphi line-numbers-mode"><pre class="language-delphi"><code>function MakeConstant(value: integer): TFunc;
begin
  Result :=
    function: integer
    begin
      Result := value;
    end;
end;

function MakeAddition(const term1, term2: TFunc): TFunc;
begin
  Result :=
    function: integer
    begin
      Result := term1() + term2();
    end;
end;
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>–í–∞–∂–Ω–∞—è —Ç–æ—á–∫–∞ –∑–¥–µ—Å—å –≤ —Ç–æ–º —á—Ç–æ –Ω–µ <code>MakeConstant</code> –Ω–µ <code>MakeAddition</code> –Ω–µ –¥–µ–ª–∞–µ—Ç –Ω–∏–∫–∞–∫–∏—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π. –û–Ω–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç –∞–Ω–æ–Ω–∏–º–Ω—ã–π –º–µ—Ç–æ–¥ –∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç —Å—Å—ã–ª–∫—É –Ω–∞ –Ω–µ–≥–æ, —á—Ç–æ –±–æ–ª–µ–µ –∏–ª–∏ –º–µ–Ω–µ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å–æ–∑–¥–∞–Ω–∏—é –æ–±—ä–µ–∫—Ç–∞ –∏ –≤–æ–∑–≤—Ä–∞—Ç—É –µ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞, –Ω–æ —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞—Ç—Ä–∞—Ç –Ω–∞ —Å–≤—è–∑—ã–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö (variable capturing).</p><p>–ö—Å—Ç–∞—Ç–∏, —Ç–∞–∫ –∫–∞–∫ –Ω–∞—à &quot;—è–∑—ã–∫&quot; —Ç–æ–ª—å–∫–æ –≤—ã—á–∏—Å–ª—è–µ—Ç —Ü–µ–ª–æ—á–∏—Å–ª–µ–Ω–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è —á—Ç–æ –≤—Å–µ–≥–¥–∞ –Ω–∞ –≤—ã—Ö–æ–¥–µ –¥–∞—ë—Ç —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ, —Ç–æ &quot;—Ñ—É–Ω–∫—Ü–∏—è –∫–æ—Ç–æ—Ä–∞—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —á–∏—Å–ª–æ&quot; –∏–ª–∏ <code>TFunc</code> —Ç–æ—á–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ –Ω–∞—à–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è.</p><p>–î–ª—è &quot;–∫–æ–º–ø–∏–ª—è—Ü–∏–∏&quot; AST –º—ã –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ–∫—É—Ä—Å–∏—é —Ç–∞–∫ –∫–∞–∫ –Ω–∞–º –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –¥–æ—á–µ—Ä–Ω–µ-–≤—ã—á–∏—Å–ª—è–µ–º—ã–µ –∞–Ω–æ–Ω–∏–º–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–µ—Ä–µ–¥ –∏—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ–º (–∫–∞–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã) –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞–Ω–æ–Ω–∏–º–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –≤—ã—á–∏—Å–ª—è—é—â–µ–π —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —É–∑–µ–ª.</p><div class="language-delphi ext-delphi line-numbers-mode"><pre class="language-delphi"><code>function CompileAST(ast: TTerm): TFunc;
var
  add1: TAddition;
  const1: TConstant;
begin
  if IsConstant(ast, const1) then
    // this node represents a constant
    Result := MakeConstant(const1.Value)
  else if IsAddition(ast, add1) then
    // this node represent an expression
    Result := MakeAddition(CompileAST(add1.Term1), CompileAST(add1.Term2))
  else

    raise Exception.Create(&#39;Internal error. Unknown AST element: &#39; +      ast.ClassName);
end;
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>–≠—Ç–æ—Ç –∫–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ—Ç–æ–º—É —á—Ç–æ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç <strong>–∑–Ω–∞—á–µ–Ω–∏–µ</strong> <code>const1.Value</code>, –∞ –Ω–µ —Å—Å—ã–ª–∫—É (—É–∫–∞–∑–∞—Ç–µ–ª—å) –Ω–∞ –Ω–µ–≥–æ. –û—Ç–∫—É–¥–∞ —è —ç—Ç–æ –∑–Ω–∞—é? –ü–æ—Ç–æ–º—É —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è <code>TestCompileAST</code> —è–≤–Ω—ã–º –æ–±—Ä–∞–∑–æ–º –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —ç—Ç–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ.</p><p>–í—ã–∑—ã–≤–∞—è <code>CompileAST(CreateAST[1,2,3])</code> –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ —Å–ª–µ–¥—É—é—â–∞—è –∞–Ω–æ–Ω–∏–º–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>(*
function: integer
begin
  Result :=
    (function: integer
     begin
       Result := 1;
     end)()
    +
    (function: integer
     begin
       Result :=
         (function: integer
          begin
            Result := 2;
          end)()
         +
         (function: integer
          begin
            Result := 3;
          end)();
     end)();

end;
*)
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>(*): —è –∑–Ω–∞—é —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º —ç—Ç–æ–≥–æ –±—É–¥–µ—Ç —É—Ç–æ—á–∫–∞ –ø–∞–º—è—Ç–∏ —Ç–∞–∫ –∫–∞–∫ AST –Ω–µ —É–Ω–∏—á—Ç–æ–∂–∞–µ—Ç—Å—è.</p><p>–¢—Ä—É–¥–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∞–Ω–æ–Ω–∏–º–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ñ–æ—Ä–º–µ, –Ω–æ –º—ã –º–æ–∂–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å –µ—ë –Ω–∞ –Ω–µ–∫–æ—Ç–æ—Ä–æ–º —á–∏—Å–ª–µ —Ç–µ—Å—Ç–æ–≤ –∏ –Ω–∞–¥–µ—è—Ç—Å—è —á—Ç–æ –≤—Å—ë –û–ö üòâ</p><div class="language-delphi ext-delphi line-numbers-mode"><pre class="language-delphi"><code>procedure TestCompileAST;

  procedure Test(const testName: string; const prog: string; expectedResult: integer);
  var
    add1      : TAddition;
    ast       : TAST;
    calcResult: integer;
    code      : TFunc;
    const1    : TConstant;
  begin
    if not (Parse(prog, ast) and assigned(ast)) then
      raise Exception.CreateFmt(&#39;Parser failed in test %s&#39;, [testName]);

    try
      code := CompileAST(ast);
      if not assigned(code) then

        raise Exception.CreateFmt(&#39;Compilation failed in test %s&#39;, [testName]);
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>–î–∞–≤–∞–π—Ç–µ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–∏–º—Å—è —á—Ç–æ <code>ast.Value</code> –±—ã–ª —Å–≤—è–∑–∞–Ω –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é –∞ –Ω–µ –ø–æ —Å—Å—ã–ª–∫–µ.</p><p>–ò–∑–º–µ–Ω–µ–Ω–∏–µ AST —Å–µ–π—á–∞—Å –Ω–µ –¥–æ–ª–∂–Ω–æ –≤–ª–∏—è—Ç—å –Ω–∞ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥.</p><div class="language-delphi ext-delphi line-numbers-mode"><pre class="language-delphi"><code>       if (IsAddition(ast, add1) and IsConstant(add1.Term1, const1))
         or IsConstant(ast, const1)
      then
        const1.Value := const1.Value + 1
      else
        raise Exception.CreateFmt(&#39;Unexpected AST format in test %s&#39;,         [testName]);

      calcResult := code(); //execute the compiled code

      if calcResult &lt;&gt; expectedResult then
        raise Exception.CreateFmt(
                &#39;Evaluation failed in test %s. &#39; +
                &#39;Codegen result %d &lt;&gt; expected result %d&#39;,
                [testName, calcResult, expectedResult]);

    finally
      FreeAndNil(ast);
    end;
  end;

begin
  Test(&#39;1&#39;, &#39;42&#39;, 42);
  Test(&#39;2&#39;, &#39;1 + 2 + 3&#39;, 6);
  Test(&#39;3&#39;, &#39;2 + 2 +3+3&#39;, 10);

end;
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>–ï—Å–ª–∏ –≤—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç, –º—ã –∑–∞–ø—É—Å—Ç–∏–º —Ü–∏–∫–ª –ß—Ç–µ–Ω–∏–µ-–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ-–í—ã–≤–æ–¥ (Read-Eval-Print Loop) —Ç–∞–∫ —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—à –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä.</p><div class="language-delphi ext-delphi line-numbers-mode"><pre class="language-delphi"><code>procedure RunREPL;
var
  ast : TAST;
  prog: string;
begin
  repeat
    Write(&#39;Enter an expression (empty line exits): &#39;);
    Readln(prog);
    if prog = &#39;&#39; then
      break;

    if not Parse(prog, ast) then
      Writeln(&#39;Syntax is not valid&#39;)
    else
      Writeln(&#39;Result is: &#39;, CompileAST(ast)());
  until false;
end;

begin
   try
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>–ó–∞–ø—É—Å—Ç–∏–º –≤—Å–µ –º–æ–¥—É–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã.</p><div class="language-delphi ext-delphi line-numbers-mode"><pre class="language-delphi"><code>     Writeln(&#39;Running AST creation tests ...&#39;);
    TestCreateAST;

    Writeln(&#39;Running tokenizer tests ...&#39;);
    TestGetToken;

    Writeln(&#39;Running parser test ...&#39;);
    TestParse;

    Writeln(&#39;Running AST interpreter tests ...&#39;);
    TestInterpretAST;

    Writeln(&#39;Running AST compilation tests ...&#39;);
    TestCompileAST;

    RunREPL;
  except
    on E: Exception do begin
      Writeln(E.ClassName, &#39;: &#39;, E.Message);
      Readln;
    end;
  end;
end.
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">–ü–æ—Å–ª–µ–¥–Ω–∏–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ: </span><span class="meta-item-info">24.08.2023, 06:42:55</span></div><!----></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script src="/assets/js/runtime~app.25176522.js" defer></script><script src="/assets/js/1812.ebb0a1a7.js" defer></script><script src="/assets/js/app.b6198e79.js" defer></script>
  </body>
</html>
